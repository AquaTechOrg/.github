# This workflow synchronizes iterations between parent issues and their sub-issues
name: Sync Sub-Issue Iterations
on:
  schedule:
    # Runs every 5 minutes to check for iteration changes
    - cron: '*/5 * * * *'
  workflow_dispatch: # Allows manual triggering for testing
  issues:
    types: [edited] # Trigger when issues are edited (including iteration changes)
jobs:
  sync_iterations:
    runs-on: ubuntu-latest
    steps:
      - name: Get project data and iteration field
        env:
          GH_TOKEN: ${{ secrets.TEST }}
          ORGANIZATION: AquaTechOrg
          PROJECT_NUMBER: 6
        run: |
          # Query project data including iteration fields
          gh api graphql -f query='
            query($org: String!, $number: Int!) {
              organization(login: $org){
                projectV2(number: $number) {
                  id
                  fields(first:50) {
                    nodes {
                      ... on ProjectV2Field {
                        id
                        name
                        dataType
                      }
                      ... on ProjectV2SingleSelectField {
                        id
                        name
                        dataType
                        options {
                          id
                          name
                        }
                      }
                      ... on ProjectV2IterationField {
                        id
                        name
                        dataType
                        configuration {
                          iterations {
                            id
                            title
                            startDate
                            duration
                          }
                        }
                      }
                    }
                  }
                }
              }
            }' -f org=$ORGANIZATION -F number=$PROJECT_NUMBER > project_data.json

          # Parse and store field IDs
          echo 'PROJECT_ID='$(jq -r '.data.organization.projectV2.id' project_data.json) >> $GITHUB_ENV
          echo 'ITERATION_FIELD_ID='$(jq -r '.data.organization.projectV2.fields.nodes[] | select(.name== "Iteration") | .id' project_data.json) >> $GITHUB_ENV

      - name: Get all project items with iterations
        env:
          GH_TOKEN: ${{ secrets.TEST }}
        run: |
          # Get all items in the project with their iteration values
          gh api graphql -f query='
            query($projectId: ID!) {
              node(id: $projectId) {
                ... on ProjectV2 {
                  items(first: 100) {
                    nodes {
                      id
                      content {
                        ... on Issue {
                          id
                          number
                          title
                          body
                          repository {
                            name
                            owner {
                              login
                            }
                          }
                        }
                      }
                      fieldValues(first: 20) {
                        nodes {
                          ... on ProjectV2ItemFieldIterationValue {
                            field {
                              ... on ProjectV2IterationField {
                                id
                                name
                              }
                            }
                            iterationId
                            title
                          }
                        }
                      }
                    }
                  }
                }
              }
            }' -f projectId=$PROJECT_ID > project_items.json

      - name: Find parent-child relationships and sync iterations
        env:
          GH_TOKEN: ${{ secrets.TEST }}
        run: |
          # Create a script to process parent-child relationships and sync iterations
          cat > sync_script.py << 'EOF'
          import json
          import re
          import subprocess
          import sys
          import os

          def run_gh_command(cmd):
              """Run a GitHub CLI command and return the result"""
              try:
                  result = subprocess.run(cmd, shell=True, capture_output=True, text=True, check=True)
                  return result.stdout.strip()
              except subprocess.CalledProcessError as e:
                  print(f"Error running command: {cmd}")
                  print(f"Error: {e.stderr}")
                  return None

          def extract_issue_references(body):
              """Extract issue references from issue body (e.g., #123, owner/repo#456)"""
              if not body:
                  return []
              
              # Pattern to match issue references
              patterns = [
                  r'#(\d+)',  # #123
                  r'(\w+/\w+)#(\d+)',  # owner/repo#123
                  r'- \[ \] #(\d+)',  # - [ ] #123 (task list format)
                  r'- \[x\] #(\d+)',  # - [x] #123 (completed task)
              ]
              
              references = []
              for pattern in patterns:
                  matches = re.findall(pattern, body)
                  for match in matches:
                      if isinstance(match, tuple):
                          if len(match) == 2:  # repo/owner format
                              references.append((match[0], int(match[1])))
                          else:
                              references.append(int(match))
                      else:
                          references.append(int(match))
              
              return references

          def get_iteration_for_item(item):
              """Get the current iteration for a project item"""
              field_values = item.get('fieldValues', {}).get('nodes', [])
              for field_value in field_values:
                  if 'iterationId' in field_value:
                      return {
                          'id': field_value.get('iterationId'),
                          'title': field_value.get('title')
                      }
              return None

          def update_item_iteration(project_id, item_id, field_id, iteration_id):
              """Update an item's iteration in the project"""
              mutation = '''
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $iterationId: String) {
                updateProjectV2ItemFieldValue(
                  input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: {
                      iterationId: $iterationId
                    }
                  }
                ) {
                  projectV2Item {
                    id
                  }
                }
              }
              '''
              
              cmd = f'''gh api graphql -f query='{mutation}' -f projectId={project_id} -f itemId={item_id} -f fieldId={field_id} -f iterationId={iteration_id}'''
              return run_gh_command(cmd)

          # Load project data
          with open('project_items.json', 'r') as f:
              project_data = json.load(f)

          items = project_data['data']['node']['items']['nodes']
          project_id = os.environ['PROJECT_ID']
          iteration_field_id = os.environ['ITERATION_FIELD_ID']

          # Build a map of issues by repository and number
          issue_map = {}
          for item in items:
              content = item.get('content')
              if content and content.get('number'):
                  repo_info = content['repository']
                  repo_key = f"{repo_info['owner']['login']}/{repo_info['name']}"
                  issue_number = content['number']
                  
                  if repo_key not in issue_map:
                      issue_map[repo_key] = {}
                  
                  issue_map[repo_key][issue_number] = {
                      'item': item,
                      'content': content,
                      'iteration': get_iteration_for_item(item)
                  }

          # Find parent-child relationships and sync iterations
          updates_made = 0
          
          for repo_key, repo_issues in issue_map.items():
              for issue_number, issue_data in repo_issues.items():
                  content = issue_data['content']
                  parent_iteration = issue_data['iteration']
                  
                  if not parent_iteration or not parent_iteration.get('id'):
                      continue
                  
                  # Find child issues referenced in the body
                  child_refs = extract_issue_references(content.get('body', ''))
                  
                  for child_ref in child_refs:
                      child_repo = repo_key
                      child_number = child_ref
                      
                      # Handle cross-repo references
                      if isinstance(child_ref, tuple):
                          child_repo, child_number = child_ref
                      
                      # Check if child issue exists in our project
                      if child_repo in issue_map and child_number in issue_map[child_repo]:
                          child_data = issue_map[child_repo][child_number]
                          child_iteration = child_data['iteration']
                          
                          # If child iteration is different from parent, update it
                          if not child_iteration or child_iteration.get('id') != parent_iteration.get('id'):
                              print(f"Syncing iteration for {child_repo}#{child_number}")
                              print(f"  From: {child_iteration.get('title', 'None') if child_iteration else 'None'}")
                              print(f"  To: {parent_iteration.get('title')}")
                              
                              result = update_item_iteration(
                                  project_id,
                                  child_data['item']['id'],
                                  iteration_field_id,
                                  parent_iteration['id']
                              )
                              
                              if result:
                                  updates_made += 1
                                  print(f"  ✓ Updated successfully")
                              else:
                                  print(f"  ✗ Update failed")

          print(f"\nTotal updates made: {updates_made}")
          EOF

          # Run the synchronization script
          python3 sync_script.py

      - name: Log synchronization results
        run: |
          echo "Iteration synchronization completed at $(date)"

