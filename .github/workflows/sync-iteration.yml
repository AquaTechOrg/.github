# This workflow synchronizes iterations between parent issues and their sub-issues
name: Sync Sub-Issue Iterations
on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:
  issues:
    types: [edited]
concurrency:
  group: sub-issue-iteration-sync
  cancel-in-progress: true
jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Load project + items
        env:
          GH_TOKEN: ${{ secrets.TEST }}
          ORG: AquaTechOrg
          PROJECT_NUMBER: 6
        run: |
          # First page (includes fields)
          gh api graphql -f query='
          query($org:String!,$num:Int!){
            organization(login:$org){
              projectV2(number:$num){
                id
                fields(first:50){
                  nodes{
                    ... on ProjectV2IterationField { id name }
                  }
                }
                items(first:100){
                  pageInfo { hasNextPage endCursor }
                  nodes{
                    id
                    content{
                      ... on Issue {
                        id
                        number
                        title
                        repository { owner { login } name }
                      }
                    }
                    fieldValues(first:10){
                      nodes{
                        ... on ProjectV2ItemFieldIterationValue {
                          field { ... on ProjectV2IterationField { id name } }
                          iterationId
                          title
                        }
                      }
                    }
                  }
                }
              }
            }
          }' -f org=$ORG -F num=$PROJECT_NUMBER > project.json

          has_next=$(jq -r '.data.organization.projectV2.items.pageInfo.hasNextPage' project.json)
          cursor=$(jq -r '.data.organization.projectV2.items.pageInfo.endCursor' project.json)

          while [ "$has_next" = "true" ] && [ "$cursor" != "null" ]; do
            echo "Fetching next page after $cursor"
            gh api graphql -f query='
            query($org:String!,$num:Int!,$after:String){
              organization(login:$org){
                projectV2(number:$num){
                  items(first:100, after:$after){
                    pageInfo { hasNextPage endCursor }
                    nodes{
                      id
                      content{
                        ... on Issue {
                          id
                          number
                          title
                          repository { owner { login } name }
                        }
                      }
                      fieldValues(first:10){
                        nodes{
                          ... on ProjectV2ItemFieldIterationValue {
                            field { ... on ProjectV2IterationField { id name } }
                            iterationId
                            title
                          }
                        }
                      }
                    }
                  }
                }
              }
            }' -f org=$ORG -F num=$PROJECT_NUMBER -f after="$cursor" > page.json

            # Merge new nodes into project.json
            jq -s '
              .[0].data.organization.projectV2.items.nodes +=
              .[1].data.organization.projectV2.items.nodes
              | .[0].data.organization.projectV2.items.pageInfo =
              .[1].data.organization.projectV2.items.pageInfo
              | .[0]
            ' project.json page.json > merged.json
            mv merged.json project.json

            has_next=$(jq -r '.data.organization.projectV2.items.pageInfo.hasNextPage' project.json)
            cursor=$(jq -r '.data.organization.projectV2.items.pageInfo.endCursor' project.json)
          done

          echo "Total items collected: $(jq '.data.organization.projectV2.items.nodes | length' project.json)"

          echo "PROJECT_ID=$(jq -r '.data.organization.projectV2.id' project.json)" >> $GITHUB_ENV
          echo "ITERATION_FIELD_ID=$(jq -r '.data.organization.projectV2.fields.nodes[] | select(.name==\"Iteration\") | .id' project.json)" >> $GITHUB_ENV
      - name: Sync iterations
        env:
          GH_TOKEN: ${{ secrets.TEST }}
        run: |
          python3 - <<'PY'
          import json, os, subprocess

          def sh(cmd):
              r = subprocess.run(cmd, shell=True, capture_output=True, text=True)
              if r.returncode!=0: print(r.stderr.strip())
              return r.stdout.strip()

          with open('project.json') as f:
              data=json.load(f)
          proj=data['data']['organization']['projectV2']
          project_id=os.environ['PROJECT_ID']
          # iteration field id
          iter_field=os.environ['ITERATION_FIELD_ID']

          # Build map: repo -> issue_number -> {item_id, iteration_id, iteration_title}
          issues={}
          for n in proj['items']['nodes']:
              c=n.get('content')
              if not c: continue
              repo=f"{c['repository']['owner']['login']}/{c['repository']['name']}"
              issues.setdefault(repo, {})[c['number']]={'item_id':n['id'],'iteration':None}
              for fv in n.get('fieldValues',{}).get('nodes',[]):
                  if fv.get('iterationId'):
                      issues[repo][c['number']]['iteration']={'id':fv['iterationId'],'title':fv.get('title')}
                      break

          # If issue event: narrow scope
          event_issue=os.environ.get('GITHUB_EVENT_NAME')=='issues' and os.environ.get('GITHUB_EVENT_PATH')
          targeted=None
          if event_issue:
              with open(os.environ['GITHUB_EVENT_PATH']) as f: ev=json.load(f)
              repo = ev['repository']['full_name']
              num  = ev['issue']['number']
              targeted=(repo,num)

          parents=[]
          for repo, nums in issues.items():
              for num, meta in nums.items():
                  it=meta['iteration']
                  if it and (not targeted or repo==targeted[0] and num==targeted[1] or not targeted):
                      parents.append((repo,num,it))

          updates=0
          for repo,num,it in parents:
              owner, name = repo.split('/',1)
              # REST children (sub-issues this issue tracks)
              out=sh(f'gh api repos/{owner}/{name}/issues/{num}/sub-issues -H "Accept: application/vnd.github+json"')
              if not out: continue
              try: children=json.loads(out)
              except: continue
              if not children: continue
              for ch in children:
                  child_repo=f"{ch['repository']['owner']['login']}/{ch['repository']['name']}"
                  child_num=ch['number']
                  if child_repo in issues and child_num in issues[child_repo]:
                      child_meta=issues[child_repo][child_num]
                      child_iter=child_meta['iteration']
                      if not child_iter or child_iter['id']!=it['id']:
                          # Update iteration
                          mutation='''
                          mutation($p:ID!,$i:ID!,$f:ID!,$val:String){
                            updateProjectV2ItemFieldValue(input:{
                              projectId:$p
                              itemId:$i
                              fieldId:$f
                              value:{ iterationId:$val }
                            }){ projectV2Item { id } }
                          }'''
                          item_id=child_meta['item_id']
                          r=sh(f"gh api graphql -f query='{mutation}' -f p={project_id} -f i={item_id} -f f={iter_field} -f val={it['id']}")
                          print(f"Updated {child_repo}#{child_num} -> {it['title']}")
                          updates+=1
          print(f"Total parents scanned: {len(parents)}")
          print(f"Iteration updates applied: {updates}")
          PY

