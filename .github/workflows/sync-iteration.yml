# This workflow synchronizes iterations between parent issues and their sub-issues
name: Sync Sub-Issue Iterations
on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:
  issues:
    types: [edited]
concurrency:
  group: sub-issue-iteration-sync
  cancel-in-progress: true
jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Load project + items
        env:
          GH_TOKEN: ${{ secrets.TEST }}
          ORG: AquaTechOrg
          PROJECT_NUMBER: 6
        run: |
          # First page (includes fields)
          gh api graphql -f query='
          query($org:String!,$num:Int!){
            organization(login:$org){
              projectV2(number:$num){
                id
                fields(first:50){
                  nodes{
                    ... on ProjectV2IterationField { id name }
                  }
                }
                items(first:100){
                  pageInfo { hasNextPage endCursor }
                  nodes{
                    id
                    content{
                      ... on Issue {
                        id
                        number
                        title
                        repository { owner { login } name }
                      }
                    }
                    fieldValues(first:10){
                      nodes{
                        ... on ProjectV2ItemFieldIterationValue {
                          field { ... on ProjectV2IterationField { id name } }
                          iterationId
                          title
                        }
                      }
                    }
                  }
                }
              }
            }
          }' -f org=$ORG -F num=$PROJECT_NUMBER > project.json

          has_next=$(jq -r '.data.organization.projectV2.items.pageInfo.hasNextPage' project.json)
          cursor=$(jq -r '.data.organization.projectV2.items.pageInfo.endCursor' project.json)

          while [ "$has_next" = "true" ] && [ "$cursor" != "null" ]; do
            echo "Fetching next page after $cursor"
            gh api graphql -f query='
            query($org:String!,$num:Int!,$after:String){
              organization(login:$org){
                projectV2(number:$num){
                  items(first:100, after:$after){
                    pageInfo { hasNextPage endCursor }
                    nodes{
                      id
                      content{
                        ... on Issue {
                          id
                          number
                          title
                          repository { owner { login } name }
                        }
                      }
                      fieldValues(first:10){
                        nodes{
                          ... on ProjectV2ItemFieldIterationValue {
                            field { ... on ProjectV2IterationField { id name } }
                            iterationId
                            title
                          }
                        }
                      }
                    }
                  }
                }
              }
            }' -f org=$ORG -F num=$PROJECT_NUMBER -f after="$cursor" > page.json

            # Merge new nodes into project.json
            jq -s '
              .[0].data.organization.projectV2.items.nodes +=
              .[1].data.organization.projectV2.items.nodes
              | .[0].data.organization.projectV2.items.pageInfo =
              .[1].data.organization.projectV2.items.pageInfo
              | .[0]
            ' project.json page.json > merged.json
            mv merged.json project.json

            has_next=$(jq -r '.data.organization.projectV2.items.pageInfo.hasNextPage' project.json)
            cursor=$(jq -r '.data.organization.projectV2.items.pageInfo.endCursor' project.json)
          done

          echo "Total items collected: $(jq '.data.organization.projectV2.items.nodes | length' project.json)"

          PROJECT_ID=$(jq -r '.data.organization.projectV2.id' project.json)
          ITERATION_FIELD_ID=$(jq -r '.data.organization.projectV2.fields.nodes
            | map(select(.name=="Iteration")) | .[0].id // empty' project.json)

          if [ -z "$ITERATION_FIELD_ID" ] || [ "$ITERATION_FIELD_ID" = "null" ]; then
            echo "No Iteration field found in project. Exiting."
            exit 0
          fi

          {
            echo "PROJECT_ID=$PROJECT_ID"
            echo "ITERATION_FIELD_ID=$ITERATION_FIELD_ID"
          } >> "$GITHUB_ENV"
      - name: Sync iterations
        env:
          GH_TOKEN: ${{ secrets.TEST }}
        run: |
          python3 - <<'PY'
          import json, os, subprocess

          def run(cmd):
              r = subprocess.run(cmd, shell=True, capture_output=True, text=True)
              if r.returncode!=0:
                  return None, r.stderr.strip()
              return r.stdout.strip(), None

          # Try dash then underscore; return list (empty list) or None (feature absent)
          def get_rest_sub_issues(owner, repo, num):
              paths = [
                  f"repos/{owner}/{repo}/issues/{num}/sub-issues",
                  f"repos/{owner}/{repo}/issues/{num}/sub_issues",
              ]
              for p in paths:
                  out, err = run(f"gh api {p} -H 'Accept: application/vnd.github+json'")
                  if err:
                      if "Not Found" in err:
                          continue
                      print(f"[REST] error {p}: {err}")
                      continue
                  if not out:
                      continue
                  try:
                      data = json.loads(out)
                      if isinstance(data, list):
                          print(f"[REST] {p} -> {len(data)} children")
                          return data
                  except json.JSONDecodeError:
                      print(f"[REST] decode error {p}")
              return None  # not available

          def get_graphql_tracked(owner, repo, num):
              q="""
              query($owner:String!,$repo:String!,$num:Int!){
                repository(owner:$owner,name:$repo){
                  issue(number:$num){
                    trackedIssues(first:100){
                      totalCount
                      nodes{
                        number
                        repository{ owner{ login } name }
                      }
                    }
                  }
                }
              }"""
              out, err = run(f"gh api graphql -f query='{q}' -f owner={owner} -f repo={repo} -F num={num}")
              if err:
                  print(f"[GraphQL] trackedIssues error {owner}/{repo}#{num}: {err}")
                  return 0, []
              try:
                  data = json.loads(out)
                  ti = data.get('data',{}).get('repository',{}).get('issue',{}).get('trackedIssues')
                  if not ti: return 0, []
                  return ti.get('totalCount',0), ti.get('nodes',[]) or []
              except Exception as e:
                  print(f"[GraphQL] parse fail {owner}/{repo}#{num}: {e}")
                  return 0, []

          with open('project.json') as f:
              data = json.load(f)
          proj = data['data']['organization']['projectV2']
          project_id = os.environ['PROJECT_ID']
          iter_field  = os.environ['ITERATION_FIELD_ID']

          issues = {}
          for n in proj['items']['nodes']:
              c = n.get('content')
              if not c: continue
              repo = f"{c['repository']['owner']['login']}/{c['repository']['name']}"
              issues.setdefault(repo, {})[c['number']] = {'item_id': n['id'], 'iteration': None}
              for fv in n.get('fieldValues', {}).get('nodes', []):
                  if fv.get('iterationId'):
                      issues[repo][c['number']]['iteration'] = {'id': fv['iterationId'], 'title': fv.get('title')}
                      break

          targeted = None
          if os.environ.get('GITHUB_EVENT_NAME') == 'issues' and os.environ.get('GITHUB_EVENT_PATH'):
              with open(os.environ['GITHUB_EVENT_PATH']) as f:
                  ev = json.load(f)
              targeted = (ev['repository']['full_name'], ev['issue']['number'])

          parents = []
          for repo, nums in issues.items():
              for num, meta in nums.items():
                  it = meta['iteration']
                  if not it: continue
                  if targeted and (repo, num) != targeted: continue
                  parents.append((repo, num, it))

          updates = 0
          for repo, num, it in parents:
              owner, name = repo.split('/',1)
              rest_children = get_rest_sub_issues(owner, name, num)
              gql_total, gql_nodes = get_graphql_tracked(owner, name, num)
              print(f"[Parent {repo}#{num}] Iteration={it['title']} REST={0 if rest_children is None else len(rest_children)} GraphQL_total={gql_total}")

              # Selection logic: prefer REST list if present; if REST unavailable (None), use GraphQL nodes; if REST empty list, also merge GraphQL.
              children = []
              if rest_children is None:
                  children.extend(gql_nodes)
              elif rest_children:
                  children.extend(rest_children)
              else:  # empty list
                  children.extend(gql_nodes)

              if not children:
                  print("  -> No children; skip")
                  continue

              for ch in children:
                  try:
                      child_repo = f"{ch['repository']['owner']['login']}/{ch['repository']['name']}"
                      child_num  = ch['number']
                  except KeyError:
                      continue
                  if child_repo in issues and child_num in issues[child_repo]:
                      child_meta = issues[child_repo][child_num]
                      child_iter = child_meta['iteration']
                      if not child_iter or child_iter['id'] != it['id']:
                          mutation = """
                          mutation($p:ID!,$i:ID!,$f:ID!,$val:String!){
                            updateProjectV2ItemFieldValue(input:{
                              projectId:$p
                              itemId:$i
                              fieldId:$f
                              value:{ iterationId:$val }
                            }){ projectV2Item { id } }
                          }"""
                          item_id = child_meta['item_id']
                          out, err = run(
                              f"gh api graphql -f query='{mutation}' -f p={project_id} -f i={item_id} -f f={iter_field} -f val={it['id']}"
                          )
                          if err:
                              print(f"  Update failed {child_repo}#{child_num}: {err}")
                          else:
                              print(f"  Updated {child_repo}#{child_num} -> {it['title']}")
                              updates += 1
                  else:
                      print(f"  Child {child_repo}#{child_num} not in project")
          print(f"Total parents scanned: {len(parents)}")
          print(f"Iteration updates applied: {updates}")
          PY

