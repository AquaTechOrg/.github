# This workflow synchronizes iterations between parent issues and their sub-issues
name: Sync Sub-Issue Iterations
on:
  schedule:
    # Runs every 5 minutes to check for iteration changes
    - cron: '*/5 * * * *'
  workflow_dispatch: # Allows manual triggering for testing
  issues:
    types: [edited] # Trigger when issues are edited (including iteration changes)
jobs:
  sync_iterations:
    runs-on: ubuntu-latest
    steps:
      - name: Get project data and iteration field
        env:
          GH_TOKEN: ${{ secrets.TEST }}
          ORGANIZATION: AquaTechOrg
          PROJECT_NUMBER: 6
        run: |
          # Query project data including iteration fields
          gh api graphql -f query='
            query($org: String!, $number: Int!) {
              organization(login: $org){
                projectV2(number: $number) {
                  id
                  fields(first:50) {
                    nodes {
                      ... on ProjectV2Field {
                        id
                        name
                        dataType
                      }
                      ... on ProjectV2SingleSelectField {
                        id
                        name
                        dataType
                        options {
                          id
                          name
                        }
                      }
                      ... on ProjectV2IterationField {
                        id
                        name
                        dataType
                        configuration {
                          iterations {
                            id
                            title
                            startDate
                            duration
                          }
                        }
                      }
                    }
                  }
                }
              }
            }' -f org=$ORGANIZATION -F number=$PROJECT_NUMBER > project_data.json

          # Parse and store field IDs
          echo 'PROJECT_ID='$(jq -r '.data.organization.projectV2.id' project_data.json) >> $GITHUB_ENV
          echo 'ITERATION_FIELD_ID='$(jq -r '.data.organization.projectV2.fields.nodes[] | select(.name== "Iteration") | .id' project_data.json) >> $GITHUB_ENV

      - name: Get all project items with iterations
        env:
          GH_TOKEN: ${{ secrets.TEST }}
        run: |
          # Get all items in the project with their iteration values
          gh api graphql -f query='
            query($projectId: ID!) {
              node(id: $projectId) {
                ... on ProjectV2 {
                  items(first: 100) {
                    nodes {
                      id
                      content {
                        ... on Issue {
                          id
                          number
                          title
                          body
                          repository {
                            name
                            owner {
                              login
                            }
                          }
                        }
                      }
                      fieldValues(first: 20) {
                        nodes {
                          ... on ProjectV2ItemFieldIterationValue {
                            field {
                              ... on ProjectV2IterationField {
                                id
                                name
                              }
                            }
                            iterationId
                            title
                          }
                        }
                      }
                    }
                  }
                }
              }
            }' -f projectId=$PROJECT_ID > project_items.json

      - name: Analyze project content
        env:
          GH_TOKEN: ${{ secrets.TEST }}
        run: |
          echo "=== PROJECT CONTENT ANALYSIS ==="
          echo "Issues in Project #6 by repository:"
          jq -r '.data.node.items.nodes[].content | select(.repository != null) | "\(.repository.owner.login)/\(.repository.name)#\(.number): \(.title)"' project_items.json | sort || echo "No issues found in project"
          
          echo ""
          echo "Total issues in project:"
          jq '.data.node.items.nodes | length' project_items.json
          
          echo "Issues with content:"
          jq '[.data.node.items.nodes[] | select(.content != null)] | length' project_items.json

      - name: Debug project data
        run: |
          echo "=== PROJECT DATA DEBUG ==="
          echo "Project items structure:"
          jq '.data.node.items.nodes | length' project_items.json
          echo "First item:"
          jq '.data.node.items.nodes[0]' project_items.json
          echo "Items with content:"
          jq '[.data.node.items.nodes[] | select(.content != null)] | length' project_items.json

      - name: Find parent-child relationships and sync iterations
        env:
          GH_TOKEN: ${{ secrets.TEST }}
        run: |
          # Create a script to process parent-child relationships and sync iterations
          cat > sync_script.py << 'EOF'
          import json
          import re
          import subprocess
          import sys
          import os

          def run_gh_command(cmd):
              """Run a GitHub CLI command and return the result"""
              try:
                  result = subprocess.run(cmd, shell=True, capture_output=True, text=True, check=True)
                  return result.stdout.strip()
              except subprocess.CalledProcessError as e:
                  print(f"Error running command: {cmd}")
                  print(f"Error: {e.stderr}")
                  return None



          def extract_issue_references(body, title="", current_repo=""):
              """Extract issue references from issue body and title"""
              if not body:
                  body = ""
              if not title:
                  title = ""
              
              full_text = f"{title}\n{body}"
              print(f"  Full text being analyzed:")
              print(f"    Title: '{title}'")
              print(f"    Body: '{body[:500]}{'...' if len(body) > 500 else ''}'")
              
              # Enhanced patterns to match various issue reference formats
              patterns = [
                  r'(?:closes?|fixes?|resolves?)\s*[:#]?\s*#(\d+)',  # closes #123
                  r'(?:closes?|fixes?|resolves?)\s+([a-zA-Z0-9\-_]+/[a-zA-Z0-9\-_]+)#(\d+)',  # closes owner/repo#123
                  r'(?:include|contains|epic|parent)\s*[:#]?\s*#(\d+)',  # includes #123
                  r'(?:sub[-\s]?(?:issue|task)|child|task)\s*[:#]?\s*#(\d+)',  # sub-issue #123
                  r'(?:related|linked)\s*[:#]?\s*#(\d+)',  # related #123
                  r'- \[[x\s]\] [^#]*#(\d+)',  # - [x] task #123, - [ ] task #123
                  r'([a-zA-Z0-9\-_]+/[a-zA-Z0-9\-_]+)#(\d+)',  # owner/repo#123 (explicit cross-repo)
                  r'(?<!\w)#(\d+)(?!\w)',  # #123 (standalone)
              ]
              
              references = []
              
              for i, pattern in enumerate(patterns):
                  matches = re.findall(pattern, full_text, re.IGNORECASE | re.MULTILINE)
                  print(f"    Pattern {i+1} '{pattern}' found {len(matches)} matches")
                  
                  for match in matches:
                      if isinstance(match, tuple):
                          if len(match) == 3 and match[1]:  # closes owner/repo#123 format
                              references.append((match[1], int(match[2])))
                              print(f"      Found cross-repo reference: {match[1]}#{match[2]}")
                          elif len(match) == 2:  # owner/repo#123 format
                              references.append((match[0], int(match[1])))
                              print(f"      Found cross-repo reference: {match[0]}#{match[1]}")
                          elif len(match) == 1:  # #123 format - use current repo
                              if current_repo:
                                  references.append((current_repo, int(match[0])))
                                  print(f"      Found same-repo reference: {current_repo}#{match[0]}")
                              else:
                                  references.append(int(match[0]))
                                  print(f"      Found reference: #{match[0]} (repo unknown)")
                      else:
                          if current_repo:
                              references.append((current_repo, int(match)))
                              print(f"      Found same-repo reference: {current_repo}#{match}")
                          else:
                              references.append(int(match))
                              print(f"      Found reference: #{match} (repo unknown)")
              
              # Remove duplicates while preserving order
              unique_refs = []
              seen = set()
              for ref in references:
                  if ref not in seen:
                      unique_refs.append(ref)
                      seen.add(ref)
              
              print(f"  Total unique text references: {len(unique_refs)}")
              return unique_refs

          def get_iteration_for_item(item):
              """Get the current iteration for a project item"""
              field_values = item.get('fieldValues', {}).get('nodes', [])
              for field_value in field_values:
                  if 'iterationId' in field_value:
                      return {
                          'id': field_value.get('iterationId'),
                          'title': field_value.get('title')
                      }
              return None

          def update_item_iteration(project_id, item_id, field_id, iteration_id):
              """Update an item's iteration in the project"""
              mutation = '''
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $iterationId: String) {
                updateProjectV2ItemFieldValue(
                  input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: {
                      iterationId: $iterationId
                    }
                  }
                ) {
                  projectV2Item {
                    id
                  }
                }
              }
              '''
              
              cmd = f'''gh api graphql -f query='{mutation}' -f projectId={project_id} -f itemId={item_id} -f fieldId={field_id} -f iterationId={iteration_id}'''
              return run_gh_command(cmd)

          # Load project data
          print("Loading project data...")
          with open('project_items.json', 'r') as f:
              project_data = json.load(f)

          items = project_data['data']['node']['items']['nodes']
          project_id = os.environ['PROJECT_ID']
          iteration_field_id = os.environ['ITERATION_FIELD_ID']
          
          print(f"Project ID: {project_id}")
          print(f"Iteration Field ID: {iteration_field_id}")
          print(f"Total items in project: {len(items)}")

          # Debug: Print first few items to understand structure
          print("\n=== DEBUG: First 3 items structure ===")
          for i, item in enumerate(items[:3]):
              print(f"Item {i+1}:")
              content = item.get('content')
              if content:
                  print(f"  Issue #{content.get('number', 'N/A')}: {content.get('title', 'No title')[:50]}...")
                  repo = content.get('repository', {})
                  print(f"  Repository: {repo.get('owner', {}).get('login', 'N/A')}/{repo.get('name', 'N/A')}")
              else:
                  print("  No content (not an issue)")
              
              iteration = get_iteration_for_item(item)
              print(f"  Current iteration: {iteration.get('title') if iteration else 'None'}")
              print()

          # Build a map of issues by repository and number
          issue_map = {}
          issues_with_iterations = 0
          issues_without_iterations = 0
          
          for item in items:
              content = item.get('content')
              if content and content.get('number'):
                  repo_info = content['repository']
                  repo_key = f"{repo_info['owner']['login']}/{repo_info['name']}"
                  issue_number = content['number']
                  
                  if repo_key not in issue_map:
                      issue_map[repo_key] = {}
                  
                  iteration = get_iteration_for_item(item)
                  if iteration and iteration.get('id'):
                      issues_with_iterations += 1
                  else:
                      issues_without_iterations += 1
                  
                  issue_map[repo_key][issue_number] = {
                      'item': item,
                      'content': content,
                      'iteration': iteration
                  }

          print(f"\n=== PROJECT SUMMARY ===")
          print(f"Total repositories: {len(issue_map)}")
          print(f"Issues with iterations: {issues_with_iterations}")
          print(f"Issues without iterations: {issues_without_iterations}")
          
          for repo_key, repo_issues in issue_map.items():
              print(f"  {repo_key}: {len(repo_issues)} issues")

          # Find parent-child relationships and sync iterations
          print(f"\n=== ANALYZING RELATIONSHIPS ===")
          updates_made = 0
          potential_parents = 0
          relationships_found = 0
          
          for repo_key, repo_issues in issue_map.items():
              for issue_number, issue_data in repo_issues.items():
                  content = issue_data['content']
                  parent_iteration = issue_data['iteration']
                  
                  print(f"\nAnalyzing {repo_key}#{issue_number}: {content.get('title', 'No title')[:50]}...")
                  
                  if not parent_iteration or not parent_iteration.get('id'):
                      print(f"  Skipping - no iteration set")
                      continue
                  
                  potential_parents += 1
                  print(f"  Parent iteration: {parent_iteration.get('title')}")
                  
                  # Find child issues referenced in the body and title
                  print(f"  Checking text-based references...")
                  child_refs = extract_issue_references(
                      content.get('body', ''), 
                      content.get('title', ''),
                      repo_key  # Pass current repo for same-repo references
                  )
                  
                  if not child_refs:
                      print(f"  No child references found")
                      continue
                  
                  relationships_found += len(child_refs)
                  print(f"  Found {len(child_refs)} child references")
                  
                  for child_ref in child_refs:
                      # Normalize child reference format
                      if isinstance(child_ref, tuple):
                          child_repo, child_number = child_ref
                      else:
                          # Fallback for old format or issues
                          child_repo = repo_key
                          child_number = child_ref
                      
                      print(f"    Checking child: {child_repo}#{child_number}")
                      
                      # Check if child issue exists in our project
                      if child_repo in issue_map and child_number in issue_map[child_repo]:
                          child_data = issue_map[child_repo][child_number]
                          child_iteration = child_data['iteration']
                          
                          print(f"      Child found in project!")
                          print(f"      Child current iteration: {child_iteration.get('title') if child_iteration else 'None'}")
                          print(f"      Parent iteration: {parent_iteration.get('title')}")
                          
                          # If child iteration is different from parent, update it
                          if not child_iteration or child_iteration.get('id') != parent_iteration.get('id'):
                              print(f"      → NEEDS UPDATE!")
                              print(f"Syncing iteration for {child_repo}#{child_number}")
                              print(f"  From: {child_iteration.get('title', 'None') if child_iteration else 'None'}")
                              print(f"  To: {parent_iteration.get('title')}")
                              
                              result = update_item_iteration(
                                  project_id,
                                  child_data['item']['id'],
                                  iteration_field_id,
                                  parent_iteration['id']
                              )
                              
                              if result:
                                  updates_made += 1
                                  print(f"  ✓ Updated successfully")
                              else:
                                  print(f"  ✗ Update failed")
                          else:
                              print(f"      → Already in sync")
                      else:
                          print(f"      Child not found in project")

          print(f"\n=== FINAL SUMMARY ===")
          print(f"Potential parent issues: {potential_parents}")
          print(f"Relationships found: {relationships_found}")
          print(f"Total updates made: {updates_made}")
          EOF

          # Run the synchronization script
          python3 sync_script.py

      - name: Check for recent iteration changes (if available)
        env:
          GH_TOKEN: ${{ secrets.TEST }}
        run: |
          echo "=== CHECKING FOR RECENT CHANGES ==="
          if [ "${{ github.event_name }}" = "issues" ]; then
            echo "Triggered by issue event - Issue #${{ github.event.issue.number }}"
            echo "Action: ${{ github.event.action }}"
          else
            echo "Triggered by schedule or manual dispatch"
          fi
          
          # List recent issues to see what we're working with
          echo "Recent issues in repositories:"
          gh search issues --owner AquaTechOrg --limit 5 --sort updated --json number,title,repository,updatedAt
          
      - name: Provide relationship setup instructions
        env:
          GH_TOKEN: ${{ secrets.TEST }}
        run: |
          echo "=== HOW TO ESTABLISH CROSS-REPOSITORY RELATIONSHIPS ==="
          echo ""
          echo "This workflow now operates ORGANIZATION-WIDE across ALL repositories!"
          echo ""
          echo "METHOD 1: GitHub Native Tracking (Recommended)"
          echo "1. Go to any parent issue (with iteration set)"
          echo "2. In the right sidebar, look for 'Tracked by' or 'Tracks' section"
          echo "3. Click 'Add tracked issue' and select issues from ANY repo"
          echo "4. Both same-repo and cross-repo tracking supported"
          echo ""
          echo "METHOD 2: Cross-Repository Text References"
          echo "1. Edit parent issue description to include:"
          echo "   Same repo:     'Sub-tasks: #123'"
          echo "   Cross repo:    'Sub-tasks: owner/repo-name#456'"
          echo "   Task list:     '- [ ] owner/other-repo#789'"
          echo "   Epic format:   'Epic includes: #123, owner/repo#456'"
          echo ""
          echo "METHOD 3: GitHub CLI Examples"
          echo "gh issue edit 1 --repo AquaTechOrg/main-repo --body 'Epic includes: #2, AquaTechOrg/backend#45'"
          echo ""
          echo "METHOD 4: Automatic Discovery"
          echo "- The workflow automatically finds all repos in AquaTechOrg"
          echo "- Issues from ANY repository can be parents/children"
          echo "- Cross-repository iteration sync is fully supported"
          echo ""
          echo "EXAMPLES OF VALID REFERENCES:"
          echo "- #123 (same repository)"
          echo "- AquaTechOrg/backend#456 (specific repository)"
          echo "- AquaTechOrg/frontend#789 (another repository)"
          echo "- owner/any-repo#999 (any repository)"

      - name: Log synchronization results
        run: |
          echo "Iteration synchronization completed at $(date)"
          echo "Check the logs above to see if any relationships were found and processed."
          echo ""
          echo "If 'Total updates made: 0', follow the relationship setup instructions above."

